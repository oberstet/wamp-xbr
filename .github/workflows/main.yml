# GitHub Actions workflow for XBR Protocol CI/CD
# https://github.com/wamp-proto/wamp-xbr/actions

name: main

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  identifiers:
    name: Identifiers
    # GitHub needs to know where .cicd/workflows/identifiers.yml lives at parse time,
    # and submodules aren't included in that context! thus the following does NOT work:
    # uses: ./.cicd/workflows/identifiers.yml
    # we MUST reference the remote repo directly:
    uses: wamp-proto/wamp-cicd/.github/workflows/identifiers.yml@main
    # IMPORTANT: we still need .cicd as a Git submodule in the using repo though!
    # because e.g. identifiers.yml wants to access scripts/sanitize.sh !

  check:
    name: Code Quality
    needs: identifiers
    runs-on: ubuntu-24.04

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Install ty (Astral type checker)
        run: uv tool install ty --prerelease=allow

      - name: Create venv and install dev dependencies
        run: |
          just create cpy311
          just install-dev cpy311

      - name: Run code quality checks
        run: just check cpy311

  test:
    name: Test Suite
    needs: identifiers
    runs-on: ${{ matrix.os }}

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    strategy:
      matrix:
        os: [ubuntu-24.04]
        env: ['cpy311', 'cpy312', 'cpy313']

    continue-on-error: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Create venv and install dependencies
        run: |
          just create ${{ matrix.env }}
          just install-dev ${{ matrix.env }}

      - name: Run tests
        run: just test ${{ matrix.env }}

  docs:
    name: Documentation
    needs: identifiers
    runs-on: ubuntu-24.04

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Create venv and install dependencies
        run: |
          just create cpy311
          just install-dev cpy311
          just install-docs cpy311

      - name: Build documentation
        run: just docs cpy311

  # Build distribution packages (sdist + wheel)
  # Artifacts are uploaded with checksums for chain-of-custody verification
  build:
    name: Build Distribution
    needs: [identifiers, check, test]
    runs-on: ubuntu-24.04

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Setup Node.js for Solidity compilation
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create venv and install build tools
        run: |
          just create cpy311
          just install-build-tools cpy311

      - name: Build distribution packages
        run: just dist cpy311

      - name: Verify packages with twine
        run: just verify-wheels cpy311

      - name: Verify wheel contents (ABI, contracts, templates)
        run: just verify-wheel-contents

      - name: List built packages
        run: |
          echo "Built packages:"
          ls -lh dist/

      - name: Upload distribution artifacts (verified)
        uses: wamp-proto/wamp-cicd/actions/upload-artifact-verified@main
        with:
          name: dist-packages
          path: dist/
          retention-days: 14

  # Verify built packages can be installed and work correctly
  verify:
    name: Verify Distribution
    needs: [identifiers, build]
    runs-on: ubuntu-24.04

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Download distribution artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-packages-*
          path: dist/
          merge-multiple: true

      - name: List downloaded packages
        run: |
          echo "Downloaded packages:"
          ls -lh dist/

      - name: Test wheel installation
        run: |
          WHEEL=$(ls -1 dist/*.whl | head -1)
          echo "Testing wheel: ${WHEEL}"
          just test-wheel-install "${WHEEL}"

      - name: Test sdist installation
        run: |
          SDIST=$(ls -1 dist/*.tar.gz | head -1)
          echo "Testing sdist: ${SDIST}"
          just test-sdist-install "${SDIST}"
